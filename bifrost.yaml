# Heimdall Policy Configuration
# "The guardian between AI agents and their tools"
#
# Wards are evaluated in order. Most restrictive decision wins: HALT > RESHAPE > PASS
# RESHAPE = make the agent useful despite the constraint (not just "no")

version: "1"
realm: "default"

defaults:
  action: PASS
  severity: low

wards:
  # === RESHAPE: Safe alternatives instead of blocking ===

  # Convert destructive commands to safe dry-run preview
  - id: reshape-destructive-to-preview
    description: "Convert rm -rf and other destructive ops to a dry-run listing"
    tool: "Bash"
    when:
      argument_matches:
        command: "(rm\\s+-rf|rm\\s+-r\\s+/|mkfs|format\\s+[A-Z]:|dd\\s+if=)"
    action: RESHAPE
    message: "Destructive command reshaped to safe dry-run preview"
    severity: high
    reshape:
      command: "echo '[HEIMDALL RESHAPE] Dry-run mode — listing affected files instead of deleting:' && ls -la"

  # Downgrade dangerous permissions to safe defaults
  - id: reshape-safe-permissions
    description: "Downgrade chmod 777 to chmod 755 for safety"
    tool: "Bash"
    when:
      argument_matches:
        command: "(chmod\\s+777)"
    action: RESHAPE
    message: "Dangerous permissions (777) downgraded to safe default (755)"
    severity: high
    reshape:
      command: "echo '[HEIMDALL RESHAPE] chmod 777 is unsafe — applied 755 instead'"

  # === HALT: Block truly dangerous operations ===

  # Block privilege escalation (cannot be safely reshaped)
  - id: halt-privilege-escalation
    description: "Prevent sudo, su, and root-level access"
    tool: "Bash"
    when:
      argument_matches:
        command: "(sudo\\s|su\\s+-|chown\\s+root)"
    action: HALT
    message: "Privilege escalation blocked — cannot be reshaped safely"
    severity: critical

  # Detect secrets in arguments (cannot be reshaped)
  - id: detect-secrets
    description: "Detect API keys and tokens in tool arguments"
    tool: "*"
    when:
      argument_contains_pattern: "(sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{36}|AKIA[0-9A-Z]{16})"
    action: HALT
    message: "Potential secret detected in tool arguments"
    severity: critical

  # === Audit: Log for review ===

  # Flag external network calls
  - id: flag-network-calls
    description: "Flag curl, wget, and network commands for audit"
    tool: "Bash"
    when:
      argument_matches:
        command: "(curl\\s|wget\\s|nc\\s|ncat\\s)"
    action: PASS
    message: "Network command logged for audit"
    severity: medium
